@model Economia_Social_Y_Solidaria.Controllers.MisCompras
@{
    ViewBag.Title = "Historial";
    Layout = "~/Views/Compartida/_layout.cshtml";
}

<div class="container comprascon" style="margin-top:100px">
</div>

<div class="modal fade" id="comentarmodal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form id="calificarform" method="post" role="form">
            <input type="hidden" name="idCompra" id="idCompra" />
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="js-title-step"></h4>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default js-btn-step pull-left" data-orientation="cancel" data-dismiss="modal"></button>
                    <button type="button" class="btn btn-warning js-btn-step" data-orientation="previous"></button>
                    <button type="button" class="btn btn-success js-btn-step" data-orientation="next"></button>

                </div>
            </div><!-- /.modal-content -->
        </form>
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="row hide" id="comentarproducto">
    <div class="row col-md-12">
        <div class="col-md-8">
            <input type="hidden" name="idProducto" class="idProducto" />
            <label>Dejanos tu opinion, nos interesa para mejorar!</label>
            <textarea name="tComentarios" required tabindex="1" class="form-control tComentarios" maxlength="180"></textarea>
            <span class="help-block pull-right totalcaracteres" style="color:red"></span>
        </div>
        <div class="col-md-4">
            <label>Puntaje</label>
            <input name="rating" type="text" class="estrellas">
        </div>
    </div>
    <div class="row col-md-12">
        <span class="help-block pull-right validacionerror" style="color:red; display:none"></span>
    </div>
</div>

<div id="compra" style="display:none">
    <div class="card">
        <div class="row">
            <img class="slide-image imagen" alt="">
        </div>
        <div class="container col-md-12">
            <div class="row">
                <div class="col-md-8">
                    <h4>Encargado en <b class="local"></b></h4>
                </div>
                <div class="col-md-4" style="text-align:right; vertical-align:middle">
                    <h6><b class="fecha"></b></h6>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8">
                    <h4>Estado del pedido: <b class="estado"></b></h4>
                </div>
            </div>

            <table class="table" id="tabla_listado">
                <thead>
                    <tr>
                        <th width="60%">Producto</th>
                        <th width="20%">Cantidad</th>
                        <th width="20%">$ Unidad</th>
                    </tr>
                </thead>
                <tbody class="productos"></tbody>
                <tfoot>

                </tfoot>
            </table>
        </div>
        <div class="row btneditar" style="display:none">
            <div class="col-md-4 col-md-offset-2">
                <button class="btn btn-card form-control modificar" data-loading-text="Borrando..."><span class="glyphicon glyphicon-edit"></span> Modificar</button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-card form-control borrar" data-loading-text="Borrando..."><span class="glyphicon glyphicon-trash"></span> Cancelar</button>
            </div>
        </div>
        <div class="row btncomentar" style="display:none">
            <div class="col-md-5 col-md-offset-3">
                <button class="btn btn-card form-control comentar" data-loading-text="Espere..."><span class="glyphicon glyphicon-pencil"></span> Comentar</button>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script type="text/javascript">
        var compras = @Html.Raw(Json.Encode(Model.Compras));
        cargarDatos(compras);

        function cargarDatos(compras){
            var container = $(".comprascon");
            container.empty();

            var actual = 0;
            while ( actual < compras.length )
            {
                var row = $("<div/>");
                row.addClass("row")
                for ( var col = 0; col < 2 && actual < compras.length ; col++){
                    agregarCompra(col, compras[actual]).appendTo(row);
                    actual++;
                }
                row.appendTo(container);
            }
        }

        function agregarCompra(col, comprado){
            //imagen local fecha estado
            var nueva = $("#compra").clone();
            nueva.addClass("col-md-5");
            if (col == 0)
                nueva.addClass("col-md-offset-1");

            nueva.find(".card").attr("data-idcompra", comprado.idCompra);
            nueva.find(".imagen").attr('src','/Imagenes/producto-' + comprado.productos[0].idProducto + '.jpg');
            nueva.find(".local").text(comprado.local + " - " + comprado.barrio);
            nueva.find(".fecha").text(comprado.fecha);
            nueva.find(".estado").text(comprado.estado);
            if (comprado.editar )
                nueva.find(".btneditar").show();
            if (comprado.comentar )
                nueva.find(".btncomentar").show();

            nueva.removeAttr('id');

            $.each(comprado.productos, function(i,val){
                nueva.find(".productos").append("<tr data-idproducto='" + comprado.productos.idProducto + "'><td>" + val.nombre+ "</td><td>" +val.cantidad+ "</td><td>$" +val.precioUnidad+ "</td></tr>");
            });
            nueva.show();

            return nueva;
        }

        $(document).on("click", ".borrar", function(e){
            $(e.currentTarget).closest('.row').find('button').button('loading')

            var id = $(".borrar").closest('.card').data("idcompra");
            $.post("/Compras/CancelarPedido", {idCompra: id}, function(data){
                cargarDatos(data.Compras);
            });

        });

        $('#comentarmodal').modalSteps({
            completeCallback: function(){
                console.log($('#comentarmodal').find("form").serialize());
                $.post("/Compras/Calificar", $('#comentarmodal').find("form").serialize(), function(devuelta){
                    if (devuelta.bien){
                        $.toast({
                            heading: 'Frente de Economía Social y Solidaria!',
                            text: 'Gracias por dejarnos tus comentarios',
                            icon: 'info',
                            loader: false,
                            hideAfter: 5000
                        })

                        $("[data-idcompra=" + devuelta.idCompra + "]").find(".btncomentar").hide();
                        $("[data-idcompra=" + devuelta.idCompra + "]").find(".estado").text(devuelta.comentario);
                    }
                });
            },
            validar: function(actual){
                var comentario = actual.find(".tComentarios").val();
                var rating = actual.find(".estrellas").val();
                var error = $(".validacionerror");

                if ( comentario.length < 5 ){
                    error.show();
                    error.text("El comentario debe tener un mínimo de 5 caracteres")
                    return false;
                } else if ( rating == 0 ){
                    error.show();
                    error.text("Hay que seleccionar al menos 1 estrella")
                    return false;
                }
                error.hide();

                return true;

                //confirm_password.setCustomValidity("Las contraseñas no coinciden");
            }
        });


        $(document).on("click", ".comentar", function(e){

            boton = $(e.currentTarget);
            boton.closest('.row').find('button').button('loading');
            var idCompra = boton.closest('.card').data('idcompra');

            var compra = returnObj(compras, idCompra);

            $("#comentarmodal").find(".modal-body").empty();
            $("#comentarmodal").find("#idCompra").val(idCompra);


            $.each(compra.productos, function(i,val){
                console.log(i,val);
                var nuevo = $("#comentarproducto").clone();
                nuevo.attr({"data-step": i + 1, "data-title": val.nombre});
                nuevo.find(".idProducto").val(val.idProducto);
                nuevo.show();

                $("#comentarmodal").find(".modal-body").append(nuevo);

            });

            $("#comentarmodal").find('#idCompra').val(idCompra);
            $("#comentarmodal").modal('show');
        });

        $("#comentarmodal").on('hidden.bs.modal', function () {
            boton.closest('.row').find('button').button('reset')
            $(".validacionerror").hide();
        });

        $("#comentarmodal").on('show.bs.modal', function () {
            $("#comentarmodal").find(".estrellas").rating({
                min:0,
                max:5,
                step:1,
                size:'xs',
                showClear:false,
                showCaption:false});
        });

        $(document).on("keyup", ".tComentarios", function(){
            var error = $(".validacionerror");
            if ( error.is(":visible"))
                error.hide();

            var caract = $(this).closest('#comentarproducto')

            var total = parseInt($(this).attr("maxlength"));
            var actuales = $(this).val().length;
            caract.find(".totalcaracteres").text("Caracteres restantes: " + (total - actuales));
        });

        //var boton = null;
        //$(document).on("click", ".comentar", function(e){

        //    boton = $(e.currentTarget);
        //    boton.closest('.row').find('button').button('loading');
        //    var idCompra = boton.closest('.card').data('idcompra');

        //    var compra = returnObj(compras, idCompra);

        //    $("#comentarmodal").find(".modal-body").empty();

        //    $.each(compra.productos, function(i,val){
        //        var nuevo = $("#comentarproducto").clone();

        //        nuevo.find(".nombre").text("Item " + (i + 1) + ": " + val.nombre);
        //        nuevo.find(".tComentarios").val("");
        //        //nuevo.find(".rating").rating('update', val.rating);

        //        $("#comentarmodal").find(".modal-body").append(nuevo.show());

        //    });

        //    $("#comentarmodal").find('#idCompra').val(idCompra);
        //    $("#comentarmodal").modal('show');
        //});

        //$("#comentarmodal").on('hidden.bs.modal', function () {
        //    boton.closest('.row').find('button').button('reset')
        //    comentarios= [];
        //});

        //$("#comentarmodal").on('show.bs.modal', function () {
        //    $.each($("#comentarmodal").find(".rating"), function(i,val){
        //        var myRating = rating(val, 0, 5);
        //    })

        //});

        /*var comentarios = [];
        var boton = null;
        $(document).on("click", ".comentar", function(e){

            boton = $(e.currentTarget);
            boton.closest('.row').find('button').button('loading');
            var idCompra = boton.closest('.card').data('idcompra');


            var compra = returnObj(compras, idCompra);

            comentarios = [];
            var prodcom = {};
            $.each(compra.productos, function(i,val){
                prodcom["idProducto"] = val.idProducto;
                prodcom["nombre"] = val.nombre;
                prodcom["comentario"] = "";
                prodcom["rating"] = 5;
                comentarios.push(prodcom);
            });


            $("#comentarmodal").find('#idCompra').val(idCompra);
            $("#comentarmodal").modal('show');
        });

        $("#comentarmodal").on('hidden.bs.modal', function () {
            boton.closest('.row').find('button').button('reset')
            comentarios= [];
        });

        //        <div class="col-md-3 col-sm-offset-6">
        //    <input type="button" data-dismiss="modal" data-loading-text="Espere..." tabindex="3" class="form-control btn btn-warning" value="Cancelar">
        //</div>
        //<div class="col-md-3">
        //    <input type="submit" data-loading-text="Espere..." tabindex="4" class="form-control btn btn-success" value="Enviar">
        //</div>

        var actual = 0;
        $("#comentarmodal").on('show.bs.modal', function () {


            actual = 0;
            crearComentario(actual)
        });

        function llenarComentario(nuevo, actual){

            var total = parseInt(nuevo.find("#tComentarios").attr("maxlength"));
            var actuales = comentarios[actual].comentario.length;

            nuevo.find("#nombre").text("Item " + (actual + 1) + ": " + comentarios[actual].nombre);
            nuevo.find("#totalcaracteres").text("Caracteres restantes: " + (total - actuales));
            nuevo.find("#tComentarios").val(comentarios[actual].comentario);
            nuevo.find("#rating").rating({'size':'xs'});
            nuevo.find("#rating").rating('update', comentarios[actual].rating);

            return nuevo;
        }

        //        <div class="col-md-3 col-sm-offset-6">
        //    <input type="button" data-dismiss="modal" data-loading-text="Espere..." tabindex="3" class="form-control btn btn-warning" value="Cancelar">
        //</div>
        //<div class="col-md-3">
        //    <input type="submit" data-loading-text="Espere..." tabindex="4" class="form-control btn btn-success" value="Enviar">
        //</div>

        function crearComentario(actual){
            var nuevo = $("#comentarproducto");

            $("#comentarmodal").find(".modal-body").empty();
            $("#comentarmodal").find(".modal-body").append(llenarComentario(nuevo, actual));

            $("#comentarmodal").find(".modal-footer").empty();
            $("#comentarmodal").find(".modal-footer").append(crearBotones(actual));
            nuevo.show();
        }

        function crearBotones(actual){
            var row = $("<div/>").addClass("row col-md-12");

            var botonGenerico = $("<input/>").addClass("btn").attr({ "type":"button", "data-loading-text":"Espere..." });

            var total = comentarios.length
            if ( actual == 0 ){
                //SIN ANTERIOR
                var siguiente = botonGenerico.clone();
                siguiente.val("Siguiente");
                siguiente.addClass("btn-primary siguiente");
                siguiente.appendTo(row);

            }
            else if ( actual == total )
            {
                //SIN SIGUIENTE -- CON GUARDAR
            }
            else{
                var siguiente = botonGenerico.clone();
                siguiente.val("Anterior");
                siguiente.addClass("btn-warning anterior");
                siguiente.appendTo(row);
            }

            return row;
        }

        $(document).on("click", ".siguiente", function(){
            actual++;
            crearComentario(actual);
        });

        $(document).on("click", ".anterior", function(){
            actual--;
            crearComentario(actual);
        });



        $(document).on("keyup", "#tComentarios", function(){
            var total = parseInt($(this).attr("maxlength"));
            var actuales = $(this).val().length;
            $("#totalcaracteres").text("Caracteres restantes: " + (total - actuales));
        });

        $("#calificarform").submit(function(e){
            e.preventDefault();
            $("#comentarmodal").modal('hide');
            var form = $(this);
            var idCompra = form.find("#idCompra").val();
            var coment = form.find("#tComentarios").val();
            var rating = form.find("#rating").val();


            $.post("/Compras/Calificar", {idCompra: idCompra, tComentarios:coment, rating:rating}, function(vuelta){
                $("[data-idcompra=" + idCompra + "]").find(".btncomentar").hide();
                $("[data-idcompra=" + idCompra + "]").find(".estado").text(vuelta);
            });

            return false;
        });*/

        function returnObj(arr,r){
            return $.grep(arr, function(elem,index){
                return elem ? elem.idCompra == r : false;
            })[0];
        }


    </script>
}
